# All-in-One Pack: ADetailer + 2x ControlNet (Enhanced v2.0)

–ü—Ä–æ—Ñ–µ—Å—ñ–π–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø–æ—Ä—Ç—Ä–µ—Ç—ñ–≤ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º Stable Diffusion WebUI, ADetailer —Ç–∞ –¥–≤–æ—Ö ControlNet –º–æ–¥–µ–ª–µ–π. **–í–µ—Ä—Å—ñ—è 2.0** –≤–∫–ª—é—á–∞—î –ø–æ–∫—Ä–∞—â–µ–Ω—É –æ–±—Ä–æ–±–∫—É –ø–æ–º–∏–ª–æ–∫, –ø–∞—Ä–∞–ª–µ–ª—å–Ω—É –æ–±—Ä–æ–±–∫—É, –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ –≥—Ä–∞—Ñ—ñ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

## –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ

- **A-Pass**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Å–æ–∫ –æ–±–ª–∏—á—á—è —Ç–∞ –∫–æ–Ω—Ç—É—Ä–Ω–∏—Ö –∫–∞—Ä—Ç
- **B-Pass**: –ü–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø–æ—Ä—Ç—Ä–µ—Ç—ñ–≤ –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º ControlNet —Ç–∞ ADetailer
- **–î–≤–∞ ControlNet**: SoftEdge SDXL –¥–ª—è —Ñ–æ—Ä–º–∏ —Ç–∞ Canny/Lineart –¥–ª—è –∫–æ–Ω—Ç—É—Ä—ñ–≤
- **ADetailer**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –¥–µ—Ç–∞–ª–µ–π –æ–±–ª–∏—á—á—è
- **Batch Processing**: –û–±—Ä–æ–±–∫–∞ –º–Ω–æ–∂–∏–Ω–∏ –∑–æ–±—Ä–∞–∂–µ–Ω—å –∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–∞–º–∏
- **Quality Control**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —è–∫–æ—Å—Ç—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ—î–∫—Ç—É

```
.
‚îú‚îÄ‚îÄ README.md
‚îú‚îÄ‚îÄ .gitignore
‚îî‚îÄ‚îÄ runpod-pack/
    ‚îú‚îÄ‚îÄ bootstrap.sh              # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
    ‚îú‚îÄ‚îÄ models_auto.py            # –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–æ–¥–µ–ª–µ–π
    ‚îú‚îÄ‚îÄ README.md                 # –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –ø–æ –∑–∞–ø—É—Å–∫—É
    ‚îî‚îÄ‚îÄ preset-contour/
        ‚îú‚îÄ‚îÄ batch.py              # üÜï –ü–æ–∫—Ä–∞—â–µ–Ω–∏–π batch –æ–±—Ä–æ–±–∫–∞ –∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–∞–º–∏
        ‚îú‚îÄ‚îÄ config.yaml           # üÜï –†–æ–∑—à–∏—Ä–µ–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
        ‚îú‚îÄ‚îÄ config_validator.py   # üÜï –í–∞–ª—ñ–¥–∞—Ç–æ—Ä –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        ‚îú‚îÄ‚îÄ config_gui.py         # üÜï –ì—Ä–∞—Ñ—ñ—á–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
        ‚îú‚îÄ‚îÄ requirements.txt      # üÜï –û–Ω–æ–≤–ª–µ–Ω—ñ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
        ‚îú‚îÄ‚îÄ run_a_pass.py         # A-Pass: —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Å–æ–∫ —Ç–∞ –∫–æ–Ω—Ç—É—Ä—ñ–≤
        ‚îî‚îÄ‚îÄ run_b_pass.py         # B-Pass: –ø–æ–∫—Ä–∞—â–µ–Ω–Ω—è –ø–æ—Ä—Ç—Ä–µ—Ç—ñ–≤
```

## –®–≤–∏–¥–∫–∏–π —Å—Ç–∞—Ä—Ç

1. **–†–æ–∑–∞—Ä—Ö—ñ–≤—É–π—Ç–µ –ø—Ä–æ—î–∫—Ç** –≤ `/workspace`
2. **–ó–∞–ø—É—Å—Ç—ñ—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É**: `cd runpod-pack && bash bootstrap.sh`
3. **–ü–æ–º—ñ—Å—Ç—ñ—Ç—å –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è** –≤ `preset-contour/input/`
4. **–ó–∞–ø—É—Å—Ç—ñ—Ç—å –æ–±—Ä–æ–±–∫—É**: `python batch.py --workers 2 --log-level INFO`

## üÜï –ù–æ–≤—ñ –∫–æ–º–∞–Ω–¥–∏

### Batch –æ–±—Ä–æ–±–∫–∞ –∑ –ø–æ–∫—Ä–∞—â–µ–Ω–∏–º–∏ –æ–ø—Ü—ñ—è–º–∏
```bash
# –ë–∞–∑–æ–≤–∞ –æ–±—Ä–æ–±–∫–∞
python batch.py

# –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∑ 4 —Ä–æ–±–æ—á–∏–º–∏ –ø—Ä–æ—Ü–µ—Å–∞–º–∏
python batch.py --workers 4

# –î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è
python batch.py --log-level DEBUG

# –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
python config_validator.py config.yaml

# –ì—Ä–∞—Ñ—ñ—á–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
python config_gui.py
```

### –ü–æ–∫—Ä–∞—â–µ–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
```yaml
general:
  max_retries: 3          # –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Å–ø—Ä–æ–± –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ
  retry_delay: 2          # –ó–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ —Å–ø—Ä–æ–±–∞–º–∏ (—Å–µ–∫—É–Ω–¥–∏)
  timeout_seconds: 300    # –¢–∞–π–º–∞—É—Ç –¥–ª—è –æ–ø–µ—Ä–∞—Ü—ñ–π

quality:
  enable_quality_check: true
  min_face_detection_confidence: 0.5
  max_blur_threshold: 100
  min_sharpness_score: 0.6

logging:
  level: "INFO"
  file_logging: true
  log_file: "adetailer_batch.log"
```

## –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è

### –û—Å–Ω–æ–≤–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ (config.yaml)
- `controlnet_weight` (0.55‚Äì0.65)
- `controlnet2_weight` (0.35‚Äì0.55)  
- `ad_denoise` (0.14‚Äì0.20)
- `steps` (26‚Äì32)
- `cfg` (4.0‚Äì4.8)

### üÜï –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ —è–∫–æ—Å—Ç—ñ
- `min_face_detection_confidence`: –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∞ –≤–ø–µ–≤–Ω–µ–Ω—ñ—Å—Ç—å –¥–µ—Ç–µ–∫—Ü—ñ—ó –æ–±–ª–∏—á—á—è
- `max_blur_threshold`: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –ø–æ—Ä—ñ–≥ —Ä–æ–∑–º–∏—Ç—Ç—è
- `min_sharpness_score`: –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –±–∞–ª —Ä—ñ–∑–∫–æ—Å—Ç—ñ

### üÜï –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- `level`: –†—ñ–≤–µ–Ω—å –ª–æ–≥—É–≤–∞–Ω–Ω—è (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- `file_logging`: –£–≤—ñ–º–∫–Ω–µ–Ω–Ω—è/–≤–∏–º–∫–Ω–µ–Ω–Ω—è –ª–æ–≥—É–≤–∞–Ω–Ω—è —É —Ñ–∞–π–ª
- `log_file`: –®–ª—è—Ö –¥–æ —Ñ–∞–π–ª—É –ª–æ–≥—É–≤–∞–Ω–Ω—è

## –ó–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ

- **Python 3.8+**
- **Stable Diffusion WebUI**
- **ControlNet extension**
- **ADetailer extension**
- **Pillow, PyYAML, requests**
- **üÜï tqdm** (–ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–∏)
- **üÜï typing-extensions** (—Ç–∏–ø—ñ–∑–∞—Ü—ñ—è)

## üÜï –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó

–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ –¥–µ—Ç–∞–ª—å–Ω–∏–º–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏ –ø—Ä–æ –ø–æ–º–∏–ª–∫–∏:

```bash
python config_validator.py config.yaml
```

## üÜï –ì—Ä–∞—Ñ—ñ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å

–ó—Ä—É—á–Ω–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –∑ –≤–∫–ª–∞–¥–∫–∞–º–∏:

```bash
python config_gui.py
```

**–í–∫–ª–∞–¥–∫–∏:**
- **General**: Backend, endpoint, retry –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è
- **B-Pass**: Prompts, –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –æ–±—Ä–æ–±–∫–∏
- **I/O**: –î–∏—Ä–µ–∫—Ç–æ—Ä—ñ—ó –≤–≤–µ–¥–µ–Ω–Ω—è/–≤–∏–≤–µ–¥–µ–Ω–Ω—è
- **Quality**: –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —è–∫–æ—Å—Ç—ñ
- **Logging**: –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –ª–æ–≥—É–≤–∞–Ω–Ω—è

## –ü—Ä–∏–∫–ª–∞–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è

### –û–±—Ä–æ–±–∫–∞ –æ–¥–Ω–æ–≥–æ –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è
```bash
python run_a_pass.py --input photo.jpg --workdir work/
python run_b_pass.py --workdir work/ --output output/
```

### Batch –æ–±—Ä–æ–±–∫–∞ –∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–æ–º
```bash
python batch.py --workers 2 --log-level INFO
```

### –í–∞–ª—ñ–¥–∞—Ü—ñ—è –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
```bash
python config_validator.py config.yaml
python batch.py --config config.yaml
```

## üÜï –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫

- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω—ñ retry** –∑ –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–∏–º backoff
- **–î–µ—Ç–∞–ª—å–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è** –ø–æ–º–∏–ª–æ–∫ —Ç–∞ –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω—å
- **Graceful degradation** –ø—Ä–∏ —á–∞—Å—Ç–∫–æ–≤–∏—Ö –∑–±–æ—è—Ö
- **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø—ñ—à–Ω–æ—Å—Ç—ñ** –æ–±—Ä–æ–±–∫–∏

## –õ—ñ—Ü–µ–Ω–∑—ñ—è

MIT License

## üÜï Changelog v2.0

- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–µ –ª–æ–≥—É–≤–∞–Ω–Ω—è –∑ –ø—Ä–æ–≥—Ä–µ—Å-–±–∞—Ä–∞–º–∏
- ‚úÖ Retry –º–µ—Ö–∞–Ω—ñ–∑–º –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ—Å—Ç—ñ
- ‚úÖ –ü–∞—Ä–∞–ª–µ–ª—å–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –∑–æ–±—Ä–∞–∂–µ–Ω—å
- ‚úÖ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó
- ‚úÖ –ì—Ä–∞—Ñ—ñ—á–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å
- ‚úÖ –†–æ–∑—à–∏—Ä–µ–Ω–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è —è–∫–æ—Å—Ç—ñ
- ‚úÖ –ü–æ–∫—Ä–∞—â–µ–Ω–∞ –æ–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫
